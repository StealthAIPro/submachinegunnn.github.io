<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Stealth Pro | v7.5</title>
    <style>
        :root { --accent: #A020F0; --bg: #0B0B0B; --card: #121212; --text: #D1D1D1; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { background: var(--bg); color: var(--text); font-family: sans-serif; margin: 0; display: flex; flex-direction: column; height: 100dvh; overflow: hidden; }
        
        header { background: var(--card); padding: 10px 20px; border-bottom: 1px solid #222; display: flex; justify-content: space-between; align-items: center; }
        .logo { color: var(--accent); font-weight: bold; }
        nav button { background: transparent; border: none; color: #555; font-size: 1.2rem; cursor: pointer; padding: 5px 10px; }
        nav button.active { color: var(--accent); }

        main { flex: 1; display: flex; flex-direction: column; padding: 15px; overflow: hidden; }
        .tab-content { display: flex; flex-direction: column; height: 100%; }
        .hidden { display: none !important; }

        #chat-window { flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 12px; padding-bottom: 10px; }
        .message { max-width: 85%; padding: 12px; border-radius: 12px; font-size: 15px; word-wrap: break-word; }
        .user { align-self: flex-end; background: var(--accent); color: white; }
        .ai { align-self: flex-start; background: var(--card); border: 1px solid #333; }
        
        .input-area { background: var(--card); padding: 12px; border-radius: 12px; border: 1px solid #333; display: flex; gap: 8px; align-items: flex-end; }
        textarea { flex: 1; background: transparent; border: none; color: white; outline: none; resize: none; font-family: inherit; font-size: 16px; padding: 5px 0; max-height: 150px; }
        .btn { background: var(--accent); color: white; border: none; padding: 10px 15px; border-radius: 8px; font-weight: bold; cursor: pointer; }
        .btn-draw { background: #222; font-size: 1.1rem; }
        
        img.gen-image { width: 100%; border-radius: 8px; margin-top: 8px; border: 1px solid #444; }
    </style>
</head>
<body>

<header>
    <div class="logo">STEALTH <span style="font-size:10px; opacity:0.5">PRO</span></div>
    <nav>
        <button id="nav-home" class="active" onclick="showTab('home')">üí¨</button>
        <button id="nav-history" onclick="showTab('history')">üìú</button>
        <button id="nav-settings" onclick="showTab('settings')">‚öôÔ∏è</button>
    </nav>
</header>

<main>
    <section id="tab-home" class="tab-content">
        <div id="chat-window"></div>
        <div id="loading" style="display:none; color:var(--accent); font-size:10px; margin-bottom:5px;">AI IS THINKING...</div>
        <div class="input-area">
            <button class="btn btn-draw" onclick="generateImage()">üé®</button>
            <textarea id="user-input" rows="1" placeholder="Ask or type to draw..."></textarea>
            <button class="btn" onclick="handleSend()">SEND</button>
        </div>
    </section>

    <section id="tab-history" class="tab-content hidden">
        <h3>History</h3>
        <div id="history-list" style="overflow-y:auto;"></div>
    </section>

    <section id="tab-settings" class="tab-content hidden">
        <h3>Settings</h3>
        <label style="font-size:12px; color:var(--accent)">MODEL ID</label>
        <input type="text" id="model-input" style="width:100%; padding:10px; background:#000; border:1px solid #333; color:#fff; border-radius:8px; margin-top:5px;">
        <button class="btn" style="width:100%; margin-top:15px;" onclick="saveSettings()">SAVE CONFIG</button>
    </section>
</main>

<script>
    let activeHistory = JSON.parse(localStorage.getItem('stealth_history') || '[]');
    let currentModel = localStorage.getItem('stealth_model') || 'google/gemini-2.0-flash-exp:free';
    document.getElementById('model-input').value = currentModel;

    // 1. FIXED: Enter to Send
    const inputField = document.getElementById('user-input');
    inputField.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            handleSend();
        }
    });

    // 2. FIXED: Tab Switching
    function showTab(name) {
        document.querySelectorAll('.tab-content').forEach(t => t.classList.add('hidden'));
        document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
        document.getElementById(`tab-${name}`).classList.remove('hidden');
        document.getElementById(`nav-${name}`).classList.add('active');
        if(name === 'history') renderHistory();
    }

    async function handleSend() {
        const text = inputField.value.trim();
        if (!text) return;

        appendMsg('user', text);
        inputField.value = '';
        inputField.style.height = 'auto';
        const aiBubble = appendEmptyMsg('ai');
        document.getElementById('loading').style.display = 'block';

        try {
            const response = await fetch("/api/chat", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ model: currentModel, messages: [{ role: "user", content: text }] })
            });

            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let fullText = "";

            while (true) {
                const { done, value } = await reader.read();
                if (done) break;
                const chunk = decoder.decode(value);
                const lines = chunk.split('\n');
                for (const line of lines) {
                    if (line.startsWith('0:')) {
                        let content = line.slice(2).trim();
                        if (content.startsWith('"') && content.endsWith('"')) content = content.slice(1, -1);
                        fullText += content.replace(/\\n/g, '\n').replace(/\\"/g, '"');
                    }
                }
                aiBubble.innerText = fullText;
                document.getElementById('chat-window').scrollTop = document.getElementById('chat-window').scrollHeight;
            }
            activeHistory.unshift({ user: text, ai: fullText, time: new Date().toLocaleTimeString() });
            localStorage.setItem('stealth_history', JSON.stringify(activeHistory));
        } catch (e) { aiBubble.innerText = "Error connecting to AI."; }
        finally { document.getElementById('loading').style.display = 'none'; }
    }

    function generateImage() {
        const prompt = inputField.value.trim();
        if (!prompt) return alert("Enter a prompt first!");
        appendMsg('user', `Draw: ${prompt}`);
        const aiBubble = appendEmptyMsg('ai');
        const img = document.createElement('img');
        img.src = `https://image.pollinations.ai/prompt/${encodeURIComponent(prompt)}?nologo=true`;
        img.className = 'gen-image';
        aiBubble.innerHTML = "Generating...";
        img.onload = () => { aiBubble.innerHTML = ""; aiBubble.appendChild(img); };
        inputField.value = "";
    }

    function renderHistory() {
        const list = document.getElementById('history-list');
        list.innerHTML = activeHistory.map(item => `
            <div style="background:#1a1a1a; padding:10px; border-radius:8px; margin-bottom:10px; border:1px solid #333">
                <small style="color:var(--accent)">${item.time}</small><br>
                <b>You:</b> ${item.user.substring(0,30)}...
            </div>
        `).join('') || 'No history yet.';
    }

    function saveSettings() {
        currentModel = document.getElementById('model-input').value.trim();
        localStorage.setItem('stealth_model', currentModel);
        alert("Model Saved!");
    }

    function appendMsg(sender, text) {
        const win = document.getElementById('chat-window');
        const d = document.createElement('div');
        d.className = `message ${sender}`;
        d.innerText = text;
        win.appendChild(d);
        win.scrollTop = win.scrollHeight;
    }

    function appendEmptyMsg(sender) {
        const win = document.getElementById('chat-window');
        const d = document.createElement('div');
        d.className = `message ${sender}`;
        win.appendChild(d);
        return d;
    }

    inputField.addEventListener('input', function() { this.style.height = 'auto'; this.style.height = (this.scrollHeight) + 'px'; });
</script>
</body>
</html>
